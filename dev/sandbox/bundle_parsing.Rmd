---
title: "UNcleR Bundle Parsing Sandbox"
output: github_document
knit: (function(input_file, ...) {
    rmarkdown::render(
      input=input_file,
      encoding="UTF-8",
      output_file = 'README.md'
    )
  })
---

```{r setup, include=FALSE}
# set chunk defaults for suppressing console message and displaying code by default
knitr::opts_chunk$set(
  message = FALSE,
  # warning = FALSE,
  echo = TRUE,
  include = TRUE
)
# set working directory for chunks and show progress bar for knitr actions
knitr::opts_knit$set(
  root.dir = "~/GitHub/UNcleR/",
  progress = TRUE
)

library(profvis)

## data loading and manipulation
# library(feather)
library(tidyverse)
# library(magrittr) # for the Tee pipe
library(readxl)

## statistics
# library(rstatix)

## plotting
library(cowplot)
# library(ggrepel)
# library(ggridges)
# library(gganimate)
# library(lemon)
library(RColorBrewer)
library(xkcdcolors)
library(extrafont)

## programming
library(glue)
library(rlang)

## interactivity
# library(crosstalk)
# library(plotly)

# user packages
# library(fragr)
library(UNcleR)
# library(RTtools)

# default style for ggplot
theme_set(
  theme_bw(base_family = "Roboto Condensed") +
    theme(
      axis.text = element_text(face = "bold"),
      panel.grid = element_blank()
    )
)


# useful variables
wellOrder <- purrr::map2_chr(rep(c(LETTERS[1:8]), 12), purrr::flatten_chr(purrr::map(c(1:12), rep, 8)), paste0)
uniOrder <- purrr::map2_chr(rep(c(LETTERS[1:16]), 3), purrr::flatten_chr(purrr::map(c(1:3), rep, 16)), paste0)
```


## Parsing Bundled Export Spectra Files

### Static Method Spectra

```{r, message=FALSE}
SLSpath <- "testing/local/T4 RNA Ligase/General Screen/210607-01-T4 RNA Ligase-Gen006L-SLS Bundle.xlsx"

SLSbundle_sheets <- readxl::excel_sheets(SLSpath) |> {
  \(x) x[match(x[x != "Sheet1"], uniOrder)]
}() |> rlang::set_names()
# SLSbundle_sheets

SLSbundle <- suppressMessages(purrr::map_dfr(SLSbundle_sheets,
  readxl::read_xlsx,
  path = SLSpath,
  skip = 3,
  col_types = "numeric",
  .name_repair = "universal",
  .id = "uni"
)) |>
tidyr::nest(FLUORspec = c(2:3), SLSspec266 = c(4:5), SLSspec473 = c(6:7)) |>
dplyr::mutate(dplyr::across(
  tidyselect::contains("spec"),
  \(lcol) purrr::map(lcol, \(df) dplyr::rename_with(df, .cols = 1, .fn = ~"temp_C"))
))
SLSbundle
```

```{r}
import_staticBundle_test <- function(path) {
  sheets <- readxl::excel_sheets(path) |> {
    \(s) s[match(s[s != "Sheet1"], uniOrder)]
  }() |> rlang::set_names()

  bundle <- suppressMessages(purrr::map_dfr(sheets,
    readxl::read_xlsx,
    path = path,
    skip = 3,
    col_types = "numeric",
    .name_repair = "universal",
    .id = "uni"
  )) |>
  tidyr::nest(FLUORspec = c(2:3), SLSspec266 = c(4:5), SLSspec473 = c(6:7)) |>
  dplyr::mutate(dplyr::across(
    tidyselect::contains("spec"),
    \(lcol) purrr::map(lcol, \(df) dplyr::rename_with(df, .cols = 1, .fn = ~"temp_C"))
  ))

  return(bundle)
}
```

```{r}
SLSbundle_files <- list.files("testing/local/T4 RNA Ligase/General Screen/",
  pattern = "SLS Bundle",
  full.names = TRUE
) |>  {
  \(path) rlang::set_names(path, nm = map_chr(path, stringr::str_extract, "(?<=//).*(?=.xlsx)"))
}()
# SLSbundle_files

SLSbundles <- purrr::map(SLSbundle_files, import_staticBundle_test) |> {
  \(l) rlang::set_names(l,
    nm = purrr::map_chr(
      SLSbundle_files,
      stringr::str_extract, "(?<=//).*(?=\\.xlsx)"
    )
  )
}()
SLSbundles
```


### Dynamic Method Spectra

```{r, message=FALSE}
DLSpath <- "testing/local/T4 RNA Ligase/General Screen/210607-01-T4 RNA Ligase-Gen006L-DLS Bundle.xlsx"

DLSbundle_sheets <- readxl::excel_sheets(DLSpath) |> {
  \(x) x[x != "Sheet1"]
}() |> rlang::set_names()
# DLSbundle_sheets

DLSbundle <- suppressMessages(purrr::map(
  DLSbundle_sheets,
  \(sheet) readxl::read_xlsx(
    path = DLSpath,
    sheet = sheet,
    skip = 2,
    col_types = "numeric",
    .name_repair = "universal"
  )
))
```

```{r}
df_i <- DLSbundle[grepl("Intensity", names(DLSbundle))] |> {
  \(bundle) rlang::set_names(bundle,
    nm = stringr::str_extract(names(bundle), "(?<=\\-)[A-P]\\d+\\-\\d+$")
  )
}() |> 
  dplyr::bind_rows(.id = "uni") |>
  tidyr::nest(specDLS_i = c(2:3))

df_m <- DLSbundle[grepl("Mass", names(DLSbundle))] |> {
  \(bundle) rlang::set_names(bundle,
    nm = stringr::str_extract(names(bundle), "(?<=\\-)[A-P]\\d+\\-\\d+$")
  )
}() |> 
  dplyr::bind_rows(.id = "uni") |>
  tidyr::nest(specDLS_m = c(2:3))

df_c <- DLSbundle[grepl("Correlation", names(DLSbundle))] |> {
  \(bundle) rlang::set_names(bundle,
    nm = stringr::str_extract(names(bundle), "(?<=\\-)[A-P]\\d+\\-\\d+$")
  )
}() |> 
  dplyr::bind_rows(.id = "uni") |>
  tidyr::nest(specDLS_c = c(2:3))

reduce(list(df_i, df_m, df_c), dplyr::left_join, by = "uni")
```

